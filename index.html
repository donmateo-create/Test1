<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Odczyt NFC - legitymacja studencka</title>
  <style>
    :root{
      --bg:#0b0b0b;
      --panel: rgba(255,255,255,0.04);
      --accent:#0b84ff;
      --text:#e6e6e6;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }
    .card{
      width:100%;
      max-width:720px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:12px;
      padding:22px;
      box-shadow:0 6px 30px rgba(0,0,0,0.6);
      box-sizing:border-box;
    }
    h1{ margin:0 0 8px 0; font-size:20px; }
    p.small{ margin:0 0 14px 0; color: #bdbdbd; font-size:13px; }
    .controls{ display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
    button{
      appearance:none;
      border:0;
      background:var(--accent);
      color:white;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,0.08);
      color:var(--text);
    }
    #log{
      white-space:pre-wrap;
      word-break:break-word;
      background:var(--panel);
      padding:12px;
      border-radius:8px;
      max-height:320px;
      overflow:auto;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;
      font-size:13px;
      color:#e8eef8;
    }
    .note{ margin-top:12px; font-size:13px; color:#cfcfcf; }
    .warn{ color:#ffb86b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Odczyt NFC - legitymacja studencka</h1>
    <p class="small">Kliknij "Start" i przyłóż legitymację do telefonu. Strona próbuje odczytać NDEF i pokaże surowe dane (HEX/tekst). Jeśli karta nie jest NDEF, Web NFC może nie zadziałać.</p>

    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" class="secondary">Stop</button>
      <button id="clearBtn" class="secondary">Wyczyść</button>
    </div>

    <div id="log">Brak odczytów.</div>

    <div class="note">
      Uwaga: Web NFC działa głównie w Chrome na Androidzie. Wiele legitymacji studenckich używa formatów niskopoziomowych (IsoDep/MIFARE DESFire) i w takim przypadku konieczna jest natywna aplikacja Android z dostępem do IsoDep/APDU.
    </div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const clearBtn = document.getElementById('clearBtn');
    const log = document.getElementById('log');

    let ndefReader = null;

    function appendLog(txt){
      const now = new Date().toLocaleTimeString();
      log.textContent = `[${now}] ${txt}\n\n` + log.textContent;
    }

    function toHex(buffer) {
      const bytes = new Uint8Array(buffer);
      return Array.from(bytes, b => b.toString(16).padStart(2,'0')).join(' ');
    }

    function tryDecodeText(record){
      try {
        // record.data może być DataView albo Uint8Array - w WebNFC spec record.data jest a DOMString? we handle DataView
        const raw = record.data;
        let bytes;
        if (raw instanceof ArrayBuffer) bytes = new Uint8Array(raw);
        else if (ArrayBuffer.isView(raw)) bytes = new Uint8Array(raw.buffer, raw.byteOffset, raw.byteLength);
        else return null;

        // UTF-8 text decode
        const decoder = new TextDecoder('utf-8');
        return decoder.decode(bytes);
      } catch(e){
        return null;
      }
    }

    async function startScan(){
      if (!('NDEFReader' in window)) {
        appendLog('Twoja przeglądarka nie obsługuje Web NFC. Użyj Chrome na Androidzie.');
        return;
      }

      try {
        ndefReader = new NDEFReader();
        await ndefReader.scan();
        appendLog('Skanowanie rozpoczęte. Przyłóż kartę.');

        ndefReader.onreadingerror = () => {
          appendLog('Błąd podczas czytania tagu.');
        };

        ndefReader.onreading = evt => {
          // Web NFC daje event.message.records
          const serial = evt.serialNumber || 'brak';
          appendLog('Tag wykryty. UID: ' + serial);
          const records = evt.message.records;
          if (!records || records.length === 0) {
            appendLog('Brak rekordów NDEF. Karta prawdopodobnie nie używa NDEF.');
            return;
          }

          for (let i=0;i<records.length;i++){
            const r = records[i];
            const parts = [];
            parts.push(`record ${i+1}: type=${r.recordType}, mediaType=${r.mediaType || 'brak'}`);

            // Spróbuj odczytać jako tekst (jeśli recordType jest 'text' albo mediaType wskazuje)
            let text = null;
            try {
              // W niektórych implementacjach record.data jest ArrayBuffer
              if (r.recordType === 'text') {
                // spec: text record ma status byte w pierwszym bajcie - ale Web NFC może już zwrócić decoded text -> use tryDecodeText
                text = tryDecodeText(r);
              } else if (r.recordType === 'url' || (r.mediaType && r.mediaType.includes('text'))) {
                text = tryDecodeText(r);
              } else {
                // general attempt
                text = tryDecodeText(r);
              }
            } catch(e) {
              text = null;
            }

            if (text) {
              parts.push('tekst: ' + text);
            }

            // pokaż surowe dane
            try {
              const raw = r.data;
              if (raw) {
                let ab;
                if (raw instanceof ArrayBuffer) ab = raw;
                else if (ArrayBuffer.isView(raw)) ab = raw.buffer;
                else ab = null;

                if (ab) {
                  parts.push('HEX: ' + toHex(ab));
                }
              }
            } catch(e){
              // ignore
            }

            appendLog(parts.join(' | '));
          }
        };
      } catch (err) {
        appendLog('Błąd inicjalizacji skanowania: ' + err.message);
      }
    }

    function stopScan(){
      if (ndefReader) {
        try {
          // nie ma oficjalnego stop() w niektórych implementacjach; workaround: assign null handlers i pozwól GC
          ndefReader.onreading = null;
          ndefReader.onreadingerror = null;
          // niektóre przeglądarki mają ndefReader.abort() jeśli użyto controller - ale nie zawsze
          appendLog('Skanowanie zatrzymane.');
        } catch(e){
          appendLog('Błąd zatrzymania: ' + e.message);
        }
        ndefReader = null;
      } else {
        appendLog('Skanowanie nie było aktywne.');
      }
    }

    startBtn.addEventListener('click', startScan);
    stopBtn.addEventListener('click', stopScan);
    clearBtn.addEventListener('click', () => { log.textContent = 'Brak odczytów.'; });

  </script>
</body>
</html>
